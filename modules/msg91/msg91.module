<?php

/**
 * @file
 * This module holds functions of MSG91 SMS Module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function msg91_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.msg91':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('MSG91 SMS integration module provides easy integration of msg91 to be used in India. Now also provides a function which can be used by developers to send SMS.') . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<p>' . t('Send SMS through blocks or call the custom function to send SMS from any other module.') . '</p>';

      return $output;
  }
}

/**
 * Function to send SMS.
 */
function msg91_send_message($mobile_number, $message, $sender_id, $route) {

  $config = \Drupal::config('msg91.settings');

  if (empty($mobile_number)) {
    \Drupal::logger('msg91')->error('Please provide mobile number for sending SMS');
    return FALSE;
  }
  if (empty($sender_id)) {
    $sender_id = $config->get('msg91_senderID');
  }
  if (empty($route)) {
    $route = $config->get('msg91_route');
  }

  $auth_key = $config->get('msg91_authKey');

  if (!empty($auth_key)) {

    $post_data = [
      'authkey' => $auth_key,
      'mobiles' => $mobile_number,
      'message' => $message,
      'sender' => $sender_id,
      'route' => $route,
    ];

    // API URL.
    $url = "https://control.msg91.com/api/sendhttp.php";

    // Init the resource.
    $ch = curl_init();
    curl_setopt_array($ch, [
      CURLOPT_URL => $url,
      CURLOPT_RETURNTRANSFER => TRUE,
      CURLOPT_POST => TRUE,
      CURLOPT_POSTFIELDS => $post_data,
    // ,CURLOPT_FOLLOWLOCATION => true.
    ]);

    // Ignore SSL certificate verification.
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);

    // Get response.
    $output = curl_exec($ch);

    // Print error if any.
    if (curl_errno($ch)) {
      \Drupal::logger('msg91')->notice('Error while sending SMS');
      echo 'error:' . curl_error($ch);
    }

    curl_close($ch);
    \Drupal::messenger()->addMessage(t('SMS Sent'));
    \Drupal::logger('msg91')->notice('SMS sent to Mobile Number ' . $mobile_number);

  }
  else {
    \Drupal::logger('msg91')->error('Please set authkey for MSG91 in order to send SMS');
    return FALSE;
  }

}
